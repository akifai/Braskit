{# TODO: The management panel needs its own set of links. #}

{#
 # Thread macros
 #}

{% macro thread(context, posts) %}
	{% import _self as post -%}

	<div class="thread" id="{{ posts[0].id }}">
		{% for p in posts %}
			{% if not p.parent %}
				{{ post.op(context, p) }}
				{% if p.omitted %}
					<div class="omitted">{{ p.omitted }} posts omitted. Click Reply to view.</div>
				{% endif %}
			{% else %}
				{{ post.reply(context, p) }}
			{% endif %}
		{% endfor %}
	</div>
{% endmacro %}

{% macro head(context, p) -%}
	{% import _self as m -%}

	<h2 class="posthead">
		<label>
			<input type="checkbox" name="delete[]" value="{{ p.id }}">
			{% if p.subject %}
				<em class="posttitle">{{ p.subject }}</em>
			{% endif %}
			<span class="postname">{{ p.name }}</span>
			{% if p.tripcode %}
				<span class="posttrip">{{ p.tripcode }}</span>
			{% endif %}
			{% if context.admin %}
				<span class="postip">(<a href="{{ self() }}?task=ip&amp;ip={{ p.ip }}">{{ p.ip }}</a>)</span>
			{% endif %}
			<span class="postdate">{{ p.date }}</span>
		</label>
		{%- spaceless %}
			<span class="reflink">
				{% if not context.thread %}
					<a href="{{ path(context.board~"/res/"~p.id~".html#"~p.id) }}" class="no">No.</a>
					<a href="{{ path(context.board~"/res/"~p.id~".html#i"~p.id) }}" class="val">{{ p.id }}</a>
				{% else %}
					<a href="#{{ p.id }}" class="no">No.</a>
					<a href="#i{{ p.id }}" class="val">{{ p.id }}</a>
				{% endif %}
			</span>
		{% endspaceless -%}
		{% if not p.parent and not context.thread %}
			<span class="replylink">[<a href="{{ m.get_reply_link(context, p) }}">Reply</a>]</span>
		{% endif %}
	</h2>
{% endmacro %}

{% macro fileinfo(context, p) %}
	<div class="imginfo">
		File: <a href="{{ path(context.board~"/src/"~p.file) }}" target="_blank">{{ p.file }}</a>
		<em>(
			{{- p.file_size_formatted }}, {{ p.image_width }}x{{ p.image_height -}}
			{%- if context.thread and p.file_original %},
				<span title="{{ p.file_original }}">{{- filename(p.file_original) -}}</span>
			{%- endif -%}
		)</em>
		{% if context.admin %}
			[<a href="{{ self() }}?task=delete&amp;delete={{ p.id }}&amp;fileonly=on&amp;board={{ context.board }}" class="imgdellink" title="Delete Image">Del</a>]
		{% endif %}
	</div>
{% endmacro %}

{% macro thumb(context, p) %}
	{% import _self as m %}

	{% if p.thumb_width and p.thumb_height %}
		<a href="{{ path(context.board~"/src/"~p.file) }}" class="thumblink" target="_blank">
			<img src="{{ path(context.board~"/thumb/"~p.thumb) }}" alt="" class="thumb" width="{{ p.thumb_width }}" height="{{ p.thumb_height }}">
		</a>
	{% else %}
		<a href="{{ path(context.board~"/src/"~p.file) }}" class="nothumb">(No thumbnail)</a>
	{% endif %}
{% endmacro %}

{% macro body(p) %}
	<div class="postbody">
		<div class="posttext">
			{{- p.message|raw -}}
			{%- if p.abbrev -%}
				<div class="abbrev">Comment too long. Click <a href="">here</a>
				to view the full text.</div>
			{%- endif -%}
		</div>
	</div>
{% endmacro %}

{% macro op(context, p) %}
	{% import _self as m -%}

	{% if p.file %}
		{{ m.fileinfo(context, p) }}
		{{ m.thumb(context, p) }}
	{% endif %}
	{{ m.head(context, p) }}
	{{ m.body(p) }}
{% endmacro %}

{% macro reply(context, p) %}
	{% import _self as m -%}

	<div class="replywrap">
		<div class="doubledash">&gt;&gt;</div>
		<div class="reply" id="{{ p.id }}">
			{{ m.head(context, p) }}
			{% if p.file %}
				{{ m.fileinfo(context, p) }}
				{{ m.thumb(context, p) }}
			{% endif %}
			{{ m.body(p) }}
		</div>
	</div>
{% endmacro %}


{#
 # Post form
 #}

{% macro postform(context) %}
	<div class="postarea">
		<form action="{{ self() }}?task=post" method="post" enctype="multipart/form-data" name="postform" id="postform">
			{# context.board shouldn't be blank - if it is, we're doing it wrong #}
			<input type="hidden" name="board" value="{{ context.board }}">
			<input type="hidden" name="parent" value="{{ context.thread ? context.thread : 0 }}">
			<table><tbody>
				<tr>
					<th>Name</th>
					<td><input type="text" name="field1" size="28"></td>
				</tr>
				<tr>
					<th>Email</th>
					<td><input type="text" name="field2" size="28"></td>
				</tr>
				<tr>
					<th>Subject</th>
					<td>
						<input type="text" name="field3" size="35">
						<input type="submit" value="Submit">
					</td>
				</tr>
				<tr>
					<th>Comment</th>
					<td><textarea name="field4" rows="4" cols="48"></textarea></td>
				</tr>
				<tr>
					<th>File</th>
					{# We use javascript to change the size. The size attribute isn't
					 # allowed on file inputs in HTML5 for some strange reason. #}
					<td><input type="file" name="file" data-size="35"></td>
				</tr>
				{% if context.admin %}
					<tr>
						<th>Options</th>
						<td>
							<div><label><input type="checkbox" name="raw" value="on"> Post with raw HTML</label></div>
							<div><label><input type="checkbox" name="capcode" value="on"> Post with capcode</label></div>
						</td>
					</tr>
				{% endif %}
			</tbody></table>

			<div class="rules">
				<ul>
					<li>Supported file types are: GIF, JPG, PNG</li>
					<li>Maximum file size allowed is {{ config.max_kb }} KB.</li>
					<li>Images greater than {{ config.max_thumb_w }}x{{ config.max_thumb_h }} pixels will be thumbnailed.</li>
				</ul>
			</div>
		</form>
	</div>
{% endmacro %}

{#
 # Links and stuff
 #}

{% macro get_reply_link(context, p) -%}
	{%- import _self as m -%}
	{% spaceless %}
		{% if not context.admin %}
			{{ path(context.board~"/res/"~p.id~".html") }}	
		{% else %}
			{{ self()~"?task=manage&board="~context.board~"&thread="~p.id }}
		{% endif %}
	{% endspaceless %}
{%- endmacro %}

{% macro get_page_link(context, i) -%}
	{% import _self as m %}
	{% spaceless %}
		{% if not context.admin %}
			{{ path(context.board~"/"~(i ? i~".html" : "index.html")) }}
		{% else %}
			{{ self()~"?task=manage"~(i ? "&page="~i : "") }}
		{% endif %}
	{% endspaceless %}
{%- endmacro %}

{% macro make_previous_page_button(context) -%}
	{%- import _self as m -%}
	{% spaceless %}
		{% if not context.admin %}
		<form action="{{ path(context.board~"/"~(context.pagenum == 1 ? "index.html" : (context.pagenum - 1)~".html")) }}" method="get">
		{% else %}
		<form action="{{ self() }}" method="get">
			<input type="hidden" name="board" value="{{ context.board }}">
			<input type="hidden" name="page" value="{{ context.pagenum - 1 }}">
			<input type="hidden" name="task" value="manage">
		{% endif %}
			<input type="submit" value="Previous">
		</form>
	{% endspaceless %}
{%- endmacro %}

{% macro make_next_page_button(context) -%}
	{%- import _self as m -%}
	{% spaceless %}
		{% if not context.admin %}
		<form action="{{ path(context.board~"/"~(context.pagenum + 1)~".html") }}" method="get">
		{% else %}
		<form action="{{ self() }}" method="get">
			<input type="hidden" name="task" value="manage">
			<input type="hidden" name="page" value="{{ context.pagenum + 1 }}">
		{% endif %}
			<input type="submit" value="Next">
		</form>
	{% endspaceless %}
{%- endmacro %}


{#
 # Various
 #}

{% macro delfile(context) %}
	<div class="deletefile">
		<label>[<input type="checkbox" name="delfile" value="on"> File Only]</label>
		<input type="submit" name="task" value="Delete">
		{% if not context.admin %}
			<input type="submit" name="task" value="Report">
		{% else %}
			<input type="submit" name="task" value="Ban">
		{% endif %}
	</div>
{% endmacro %}

{% macro returnlink(context, dest="") -%}
	{% if dest %}
		[<a href="{{ dest }}">Return</a>]
	{% elseif context.admin %}
		{% if context.board %}
			[<a href="{{ self() }}?task=manage&board={{ context.board }}">Return</a>]
		{% else %}
			[<a href="{{ self() }}?task=login">Return</a>]
		{% endif %}
	{% else %}
		[<a href="{{ path(context.board ~ "/index.html") }}">Return</a>]
	{% endif %}
{%- endmacro %}
